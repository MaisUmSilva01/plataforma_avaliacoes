<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Projeto Crescendo Juntos - Sistema Estabilizado</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary: #f97316;
            --primary-dark: #ea580c;
            --bg-gradient: linear-gradient(135deg, #fbbf24 0%, #f97316 100%);
            --card-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg-gradient); min-height: 100vh; color: #1f2937; }

        /* TELA DE LOGIN */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-gradient); display: flex; justify-content: center; align-items: center; z-index: 9999;
        }
        .login-card {
            background: white; padding: 40px; border-radius: 20px; box-shadow: var(--card-shadow);
            text-align: center; max-width: 400px; width: 90%;
        }
        .login-card h2 { color: var(--primary-dark); margin-bottom: 10px; }
        .login-card input {
            width: 100%; padding: 12px; margin: 15px 0; border: 2px solid #e5e7eb; border-radius: 10px; text-align: center; font-size: 1.1em;
        }

        /* CONTE√öDO PRINCIPAL */
        #main-content { display: none; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header, .tabs, .card { background: white; border-radius: 15px; box-shadow: var(--card-shadow); margin-bottom: 20px; padding: 25px; }
        .header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
        .header h1 { color: #92400e; }
        
        .tabs { display: flex; gap: 10px; padding: 10px 20px; }
        .tab-btn { padding: 12px 25px; border: none; background: transparent; cursor: pointer; font-weight: 600; color: #6b7280; border-bottom: 3px solid transparent; transition: 0.3s; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-small { padding: 5px 10px; font-size: 0.8em; }

        .control-panel { background: #fff7ed; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap; border: 1px solid #ffedd5; }
        
        .educando-row { background: #fafafa; padding: 20px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #e5e7eb; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
        th { background: #f3f4f6; padding: 10px; text-align: left; font-size: 0.85em; color: #4b5563; }
        td { padding: 10px; border-bottom: 1px solid #f3f4f6; }
        
        select { padding: 8px; border-radius: 8px; border: 2px solid #e5e7eb; outline-color: var(--primary); background: white; }
        .chart-container { position: relative; height: 450px; width: 100%; }
        .empty-state { text-align: center; padding: 40px; color: #9ca3af; font-style: italic; }
        
        /* Modal */
        .modal { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-close { cursor: pointer; font-size: 24px; color: #6b7280; }
        .turma-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f9fafb; border-radius: 8px; margin-bottom: 10px; }
        
        /* Sistema de Notifica√ß√µes */
        .notification-container { position: fixed; top: 20px; right: 20px; z-index: 10001; display: flex; flex-direction: column; gap: 10px; max-width: 400px; }
        .notification { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; align-items: start; gap: 15px; animation: slideIn 0.3s ease; border-left: 4px solid #10b981; }
        .notification.success { border-left-color: #10b981; }
        .notification.error { border-left-color: #ef4444; }
        .notification.warning { border-left-color: #f59e0b; }
        .notification.info { border-left-color: #3b82f6; }
        .notification-icon { font-size: 24px; }
        .notification-content { flex: 1; }
        .notification-title { font-weight: 600; margin-bottom: 5px; color: #1f2937; }
        .notification-message { color: #6b7280; font-size: 0.9em; }
        .notification-close { cursor: pointer; color: #9ca3af; font-size: 20px; line-height: 1; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        /* Modal de Confirma√ß√£o */
        .confirm-modal .modal-content { max-width: 450px; text-align: center; }
        .confirm-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .confirm-buttons button { flex: 1; }
        
        /* Modal de Prompt */
        .prompt-modal .modal-content { max-width: 450px; }
        .prompt-input { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; margin: 15px 0; font-size: 1em; }
        .prompt-buttons { display: flex; gap: 10px; margin-top: 10px; }
        .prompt-buttons button { flex: 1; }
    </style>
</head>
<body>

<!-- Container de Notifica√ß√µes -->
<div id="notificationContainer" class="notification-container"></div>

<!-- Modal de Confirma√ß√£o -->
<div id="modalConfirm" class="modal confirm-modal">
    <div class="modal-content">
        <div id="confirmIcon" style="font-size: 48px; margin-bottom: 15px;">‚ö†Ô∏è</div>
        <h3 id="confirmTitle" style="margin-bottom: 10px;">Confirma√ß√£o</h3>
        <p id="confirmMessage" style="color: #6b7280; margin-bottom: 20px;">Deseja continuar?</p>
        <div class="confirm-buttons">
            <button class="btn btn-danger" onclick="confirmarAcao(false)">Cancelar</button>
            <button class="btn btn-primary" onclick="confirmarAcao(true)">Confirmar</button>
        </div>
    </div>
</div>

<!-- Modal de Prompt -->
<div id="modalPrompt" class="modal prompt-modal">
    <div class="modal-content">
        <h3 id="promptTitle" style="margin-bottom: 10px;">Digite a informa√ß√£o</h3>
        <p id="promptMessage" style="color: #6b7280; margin-bottom: 10px;"></p>
        <input type="text" id="promptInput" class="prompt-input" placeholder="Digite aqui...">
        <div class="prompt-buttons">
            <button class="btn btn-danger" onclick="confirmarPrompt(null)">Cancelar</button>
            <button class="btn btn-primary" onclick="confirmarPrompt(document.getElementById('promptInput').value)">OK</button>
        </div>
    </div>
</div>

<div id="login-screen">
    <div class="login-card">
        <h2>üîí Acesso Restrito</h2>
        <p style="color: #6b7280; margin-bottom: 20px;">Digite a senha para acessar o sistema</p>
        <input type="password" id="access-key" placeholder="Digite a senha" onkeypress="if(event.key==='Enter') handleLogin()">
        <button class="btn btn-primary" style="width: 100%; justify-content: center;" onclick="handleLogin()">Entrar</button>
        <p id="login-error" style="color: #ef4444; margin-top: 10px; display: none;">Senha incorreta. Tente novamente.</p>
    </div>
</div>

<div id="main-content">
    <div class="container">
        <header class="header">
            <div><h1>Crescendo Juntos</h1><p>An√°lise de Evolu√ß√£o Pedag√≥gica</p></div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="document.getElementById('fileInputLista').click()">üìã Importar Lista</button>
                <button class="btn btn-primary" onclick="document.getElementById('fileInputBackup').click()">üíæ Importar Backup</button>
                <button class="btn btn-success" onclick="exportarBackup()">Exportar Backup</button>
                <button class="btn btn-danger btn-small" onclick="logout()">Sair</button>
                <input type="file" id="fileInputLista" accept=".csv,.xls,.xlsx" style="display:none" onchange="processarListaAlunos(this)">
                <input type="file" id="fileInputBackup" accept=".csv,.xls,.xlsx" style="display:none" onchange="processarBackup(this)">
            </div>
        </header>

        <nav class="tabs">
            <button class="tab-btn active" onclick="mudarAba('visao-geral', this)">Painel de Gr√°ficos</button>
            <button class="tab-btn" onclick="mudarAba('avaliacoes', this)">Lan√ßar Notas (1-4)</button>
        </nav>

        <div id="visao-geral" class="tab-content active">
            <div class="card">
                <h3 style="margin-bottom: 20px;">‚öôÔ∏è Configura√ß√£o de Compara√ß√£o</h3>
                
                <div style="background: #f9fafb; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #374151;">
                            üìä Selecione as Turmas (at√© 4):
                        </label>
                        <div id="checkboxTurmas" style="display: flex; flex-wrap: wrap; gap: 15px;">
                            <!-- Ser√° preenchido dinamicamente -->
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #374151;">
                            üìÖ Selecione as Etapas:
                        </label>
                        <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" class="checkbox-etapa" value="Diagn√≥stica" checked onchange="atualizarGrafico()">
                                <span>Diagn√≥stica</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" class="checkbox-etapa" value="Processo" onchange="atualizarGrafico()">
                                <span>Processo</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" class="checkbox-etapa" value="Final" onchange="atualizarGrafico()">
                                <span>Final</span>
                            </label>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <select id="tipoGrafico" onchange="atualizarGrafico()" style="flex: 1; min-width: 150px;">
                            <option value="bar">Gr√°fico de Barras</option>
                            <option value="radar">Gr√°fico Radar</option>
                            <option value="line">Gr√°fico de Linhas</option>
                        </select>
                        <button class="btn btn-primary" onclick="selecionarTodasTurmas()">Todas as Turmas</button>
                        <button class="btn btn-danger btn-small" onclick="limparSelecaoTurmas()">Limpar</button>
                        <button class="btn btn-success" onclick="abrirModalExportar()">üì• Exportar Gr√°fico</button>
                    </div>
                </div>
                
                <div class="chart-container"><canvas id="graficoIndicadores"></canvas></div>
            </div>
            <div class="card">
                <h3>Vis√£o geral das turmas</h3>
                <div id="visaoTurmasContainer" class="empty-state">Nenhuma turma cadastrada.</div>
            </div>
        </div>

        <div id="avaliacoes" class="tab-content">
            <div class="card">
                <div class="control-panel">
                    <div style="flex-grow: 1;">
                        <label><strong>Filtrar Turma:</strong></label>
                        <select class="filtro-turma" id="turmaAtivaAvaliacao" onchange="atualizarListaEducandos()"></select>
                    </div>
                    <button class="btn btn-success" onclick="gerenciarTurmas()">üìö Gerenciar Turmas</button>
                    <button class="btn btn-primary" onclick="adicionarEducando()">+ Novo Aluno</button>
                    <button class="btn btn-danger btn-small" onclick="limparTudo()">Resetar Sistema</button>
                </div>
                <div id="educandosContainer"></div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Gerenciamento de Turmas -->
<div id="modalTurmas" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üìö Gerenciar Turmas</h2>
            <span class="modal-close" onclick="fecharModalTurmas()">&times;</span>
        </div>
        
        <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: 600; margin-bottom: 10px;">Adicionar Nova Turma:</label>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="inputNovaTurma" placeholder="Ex: 3¬∫ Ano A" style="flex: 1; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                <button class="btn btn-primary" onclick="adicionarNovaTurma()">Adicionar</button>
            </div>
        </div>
        
        <div>
            <label style="display: block; font-weight: 600; margin-bottom: 10px;">Turmas Cadastradas:</label>
            <div id="listaTurmasModal"></div>
        </div>
    </div>
</div>

<!-- Modal de Exporta√ß√£o de Gr√°fico -->
<div id="modalExportar" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üì• Exportar Gr√°fico</h2>
            <span class="modal-close" onclick="fecharModalExportar()">&times;</span>
        </div>
        
        <p style="color: #6b7280; margin-bottom: 20px;">Escolha o formato para exportar o gr√°fico atual:</p>
        
        <div style="display: flex; flex-direction: column; gap: 10px;">
            <button class="btn btn-primary" style="width: 100%; justify-content: center;" onclick="exportarGrafico('png')">
                üñºÔ∏è Exportar como PNG (Alta Qualidade)
            </button>
            <button class="btn btn-primary" style="width: 100%; justify-content: center;" onclick="exportarGrafico('jpg')">
                üì∑ Exportar como JPG (Compacto)
            </button>
            <button class="btn btn-success" style="width: 100%; justify-content: center;" onclick="exportarGrafico('pdf')">
                üìÑ Exportar como PDF (Documento)
            </button>
        </div>
        
        <div style="margin-top: 20px; padding: 15px; background: #fef3c7; border-radius: 8px; border: 1px solid #fbbf24;">
            <p style="font-size: 0.9em; color: #92400e;">
                <strong>üí° Dica:</strong> O gr√°fico ser√° exportado exatamente como est√° sendo visualizado no momento.
            </p>
        </div>
    </div>
</div>

<script>
    const CHAVE_MESTRA = "Z2lyYXNzb2xfMTIz";
    
    // Configura√ß√£o Supabase - usando API REST diretamente
    const SUPABASE_URL = 'https://nlwugowutekyrhybxnil.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5sd3Vnb3d1dGVreXJoeWJ4bmlsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NTM0MzYsImV4cCI6MjA4MzQyOTQzNn0.ebKFq1SMeOZqO4SJCcec8zfrarmzWoiwEetEc_BQFyQ';
    
    // Cliente Supabase REST API
    const supabase = {
        from: (table) => {
            const headers = {
                'apikey': SUPABASE_KEY,
                'Authorization': `Bearer ${SUPABASE_KEY}`,
                'Content-Type': 'application/json',
                'Prefer': 'return=representation'
            };
            
            return {
                select: (columns = '*') => ({
                    order: (column, opts = {}) => ({
                        then: (resolve, reject) => {
                            const orderParam = opts.ascending === false ? `${column}.desc` : `${column}.asc`;
                            fetch(`${SUPABASE_URL}/rest/v1/${table}?select=${columns}&order=${orderParam}`, { headers })
                                .then(r => r.json())
                                .then(data => resolve({ data, error: null }))
                                .catch(error => resolve({ data: null, error }));
                        }
                    }),
                    eq: (column, value) => ({
                        single: () => ({
                            then: (resolve, reject) => {
                                fetch(`${SUPABASE_URL}/rest/v1/${table}?select=${columns}&${column}=eq.${value}`, { headers })
                                    .then(r => r.json())
                                    .then(data => resolve({ data: data[0] || null, error: null }))
                                    .catch(error => resolve({ data: null, error }));
                            }
                        }),
                        then: (resolve, reject) => {
                            fetch(`${SUPABASE_URL}/rest/v1/${table}?select=${columns}&${column}=eq.${value}`, { headers })
                                .then(r => r.json())
                                .then(data => resolve({ data, error: null }))
                                .catch(error => resolve({ data: null, error }));
                        }
                    }),
                    then: (resolve, reject) => {
                        fetch(`${SUPABASE_URL}/rest/v1/${table}?select=${columns}`, { headers })
                            .then(r => r.json())
                            .then(data => resolve({ data, error: null }))
                            .catch(error => resolve({ data: null, error }));
                    }
                }),
                insert: (values) => ({
                    then: (resolve, reject) => {
                        fetch(`${SUPABASE_URL}/rest/v1/${table}`, {
                            method: 'POST',
                            headers,
                            body: JSON.stringify(Array.isArray(values) ? values : [values])
                        })
                        .then(r => r.ok ? r.json().catch(() => ({})) : Promise.reject(r))
                        .then(data => resolve({ data, error: null }))
                        .catch(error => resolve({ data: null, error }));
                    }
                }),
                update: (values) => ({
                    eq: (column, value) => ({
                        then: (resolve, reject) => {
                            fetch(`${SUPABASE_URL}/rest/v1/${table}?${column}=eq.${value}`, {
                                method: 'PATCH',
                                headers,
                                body: JSON.stringify(values)
                            })
                            .then(r => r.ok ? r.json().catch(() => ({})) : Promise.reject(r))
                            .then(data => resolve({ data, error: null }))
                            .catch(error => resolve({ data: null, error }));
                        }
                    })
                }),
                delete: () => ({
                    eq: (column, value) => ({
                        then: (resolve, reject) => {
                            fetch(`${SUPABASE_URL}/rest/v1/${table}?${column}=eq.${value}`, {
                                method: 'DELETE',
                                headers
                            })
                            .then(r => r.ok ? resolve({ data: null, error: null }) : Promise.reject(r))
                            .catch(error => resolve({ data: null, error }));
                        }
                    }),
                    neq: (column, value) => ({
                        then: (resolve, reject) => {
                            fetch(`${SUPABASE_URL}/rest/v1/${table}?${column}=neq.${value}`, {
                                method: 'DELETE',
                                headers
                            })
                            .then(r => r.ok ? resolve({ data: null, error: null }) : Promise.reject(r))
                            .catch(error => resolve({ data: null, error }));
                        }
                    })
                })
            };
        }
    };
    
    console.log('‚úì Cliente Supabase REST inicializado');
    
    // Sistema de Notifica√ß√µes
    let confirmCallback = null;
    let promptCallback = null;
    
    function mostrarNotificacao(titulo, mensagem, tipo = 'success') {
        const container = document.getElementById('notificationContainer');
        const notification = document.createElement('div');
        notification.className = `notification ${tipo}`;
        
        const icones = {
            success: '‚úì',
            error: '‚úï',
            warning: '‚ö†Ô∏è',
            info: '‚ÑπÔ∏è'
        };
        
        notification.innerHTML = `
            <div class="notification-icon">${icones[tipo]}</div>
            <div class="notification-content">
                <div class="notification-title">${titulo}</div>
                <div class="notification-message">${mensagem}</div>
            </div>
            <span class="notification-close" onclick="this.parentElement.remove()">√ó</span>
        `;
        
        container.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideIn 0.3s ease reverse';
            setTimeout(() => notification.remove(), 300);
        }, 5000);
    }
    
    function confirmar(titulo, mensagem, icone = '‚ö†Ô∏è') {
        return new Promise((resolve) => {
            document.getElementById('confirmIcon').textContent = icone;
            document.getElementById('confirmTitle').textContent = titulo;
            document.getElementById('confirmMessage').textContent = mensagem;
            document.getElementById('modalConfirm').classList.add('active');
            
            confirmCallback = resolve;
        });
    }
    
    function confirmarAcao(resultado) {
        document.getElementById('modalConfirm').classList.remove('active');
        if(confirmCallback) {
            confirmCallback(resultado);
            confirmCallback = null;
        }
    }

    function perguntar(titulo, mensagem = '', placeholder = 'Digite aqui...') {
        return new Promise((resolve) => {
            document.getElementById('promptTitle').textContent = titulo;
            document.getElementById('promptMessage').textContent = mensagem;
            const input = document.getElementById('promptInput');
            input.value = '';
            input.placeholder = placeholder;
            document.getElementById('modalPrompt').classList.add('active');
            
            // Foca no input
            setTimeout(() => input.focus(), 100);
            
            // Permite Enter para confirmar
            input.onkeypress = (e) => {
                if(e.key === 'Enter') {
                    confirmarPrompt(input.value);
                }
            };
            
            promptCallback = resolve;
        });
    }
    
    function confirmarPrompt(valor) {
        document.getElementById('modalPrompt').classList.remove('active');
        if(promptCallback) {
            promptCallback(valor ? valor.trim() : null);
            promptCallback = null;
        }
    }

    function handleLogin() {
        const campo = document.getElementById('access-key');
        const senhaDigitada = campo.value.trim();
        if (btoa(senhaDigitada) === CHAVE_MESTRA) {
            sessionStorage.setItem('projeto_auth', 'true');
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            inicializarSistema();
        } else {
            document.getElementById('login-error').style.display = 'block';
            campo.value = '';
        }
    }

    if(sessionStorage.getItem('projeto_auth') === 'true') {
        document.addEventListener('DOMContentLoaded', async () => {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            await inicializarSistema();
        });
    }

    async function inicializarSistema() {
        console.log('üöÄ Iniciando sistema...');
        await carregarDados();
        atualizarFiltrosTurma();
        atualizarAbaAtiva();
        console.log('‚úì Sistema inicializado!');
    }

    const INDICADORES = ['Leitura', 'Escrita', 'Socializa√ß√£o', 'Participa√ß√£o', 'Autonomia', 'Racioc√≠nio L√≥gico'];
    const MAPA_INDICADORES = {
        'Leitura': 'leitura',
        'Escrita': 'escrita',
        'Socializa√ß√£o': 'socializacao',
        'Participa√ß√£o': 'participacao',
        'Autonomia': 'autonomia',
        'Racioc√≠nio L√≥gico': 'raciocinio_logico'
    };
    const ETAPAS = ['Diagn√≥stica', 'Processo', 'Final'];
    const CORES = { 'Diagn√≥stica': '#f59e0b', 'Processo': '#3b82f6', 'Final': '#10b981' };
    const CORES_TURMAS = ['#ef4444', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316', '#06b6d4'];
    let dados = { educandos: [], turmas: [], avaliacoes: {} };
    let graficoInstance = null;

    window.onload = async () => {
        console.log('‚úì Sistema usando Supabase REST API direto');
        
        if(sessionStorage.getItem('projeto_auth') === 'true') {
            await inicializarSistema();
        }
    };

    async function carregarDados() {
        try {
            console.log('üìä Carregando dados...');
            mostrarNotificacao('Carregando', 'Carregando dados do servidor...', 'info');
            
            // Carrega educandos
            console.log('‚Üí Buscando educandos...');
            const { data: educandos, error: erroEducandos } = await supabase
                .from('educandos')
                .select('*')
                .order('nome');
            
            if (erroEducandos) {
                console.error('‚ùå Erro ao buscar educandos:', erroEducandos);
                throw erroEducandos;
            }
            console.log(`‚úì ${educandos?.length || 0} educandos carregados`);
            
            // Carrega avalia√ß√µes
            console.log('‚Üí Buscando avalia√ß√µes...');
            const { data: avaliacoes, error: erroAvaliacoes } = await supabase
                .from('avaliacoes')
                .select('*');
            
            if (erroAvaliacoes) {
                console.error('‚ùå Erro ao buscar avalia√ß√µes:', erroAvaliacoes);
                throw erroAvaliacoes;
            }
            console.log(`‚úì ${avaliacoes?.length || 0} avalia√ß√µes carregadas`);
            
            // Processa dados
            dados.educandos = educandos || [];
            dados.turmas = [...new Set(educandos?.map(e => e.turma) || [])].sort();
            
            // Organiza avalia√ß√µes por educando
            dados.avaliacoes = {};
            educandos?.forEach(edu => {
                dados.avaliacoes[edu.id] = { 'Diagn√≥stica': {}, 'Processo': {}, 'Final': {} };
            });
            
            avaliacoes?.forEach(aval => {
                if (!dados.avaliacoes[aval.educando_id]) {
                    dados.avaliacoes[aval.educando_id] = { 'Diagn√≥stica': {}, 'Processo': {}, 'Final': {} };
                }
                
                dados.avaliacoes[aval.educando_id][aval.etapa] = {
                    'Leitura': aval.leitura || 0,
                    'Escrita': aval.escrita || 0,
                    'Socializa√ß√£o': aval.socializacao || 0,
                    'Participa√ß√£o': aval.participacao || 0,
                    'Autonomia': aval.autonomia || 0,
                    'Racioc√≠nio L√≥gico': aval.raciocinio_logico || 0
                };
            });
            
            console.log('‚úì Dados processados:', {
                educandos: dados.educandos.length,
                turmas: dados.turmas.length,
                avaliacoes: Object.keys(dados.avaliacoes).length
            });
            
            mostrarNotificacao('Sucesso', 'Sistema pronto para uso!', 'success');
        } catch (erro) {
            console.error('‚ùå Erro ao carregar dados:', erro);
            mostrarNotificacao('Erro', 'Erro ao carregar dados. Verifique o console para detalhes.', 'error');
        }
    }

    function logout() { sessionStorage.removeItem('projeto_auth'); location.reload(); }

    function mudarAba(aba, btn) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(aba).classList.add('active');
        btn.classList.add('active');
        atualizarAbaAtiva();
    }

    function atualizarVisaoGeral() {
        const container = document.getElementById('visaoTurmasContainer');
        if(!container) return;
        if(!dados.turmas || dados.turmas.length === 0) {
            container.innerHTML = '<div class="empty-state">Nenhuma turma cadastrada.</div>';
            return;
        }
        container.innerHTML = dados.turmas.sort().map(t => {
            const count = dados.educandos.filter(e => e.turma === t).length;
            return `<div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #f3f4f6;"><strong>${t}</strong><span>${count} aluno${count !== 1 ? 's' : ''}</span></div>`;
        }).join('');
    }

    function atualizarAbaAtiva() {
        const abaVisaoGeral = document.getElementById('visao-geral');
        const abaAvaliacoes = document.getElementById('avaliacoes');

        if (abaVisaoGeral.classList.contains('active')) {
            atualizarCheckboxesTurmas();
            atualizarGrafico();
            atualizarVisaoGeral();
        }

        if (abaAvaliacoes.classList.contains('active')) {
            atualizarListaEducandos();
        }
    }

    function atualizarListaEducandos() {
        const turma = document.getElementById('turmaAtivaAvaliacao').value;
        const container = document.getElementById('educandosContainer');
        if (!turma) { container.innerHTML = '<div class="empty-state">Selecione uma turma acima.</div>'; return; }
        const lista = dados.educandos.filter(e => e.turma === turma);
        
        if(lista.length === 0) {
            container.innerHTML = '<div class="empty-state">Nenhum aluno cadastrado nesta turma.</div>';
            return;
        }
        
        container.innerHTML = lista.map(edu => `
            <div class="educando-row">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; flex-wrap:wrap; gap:10px;">
                    <strong style="flex-grow:1;">${edu.nome}</strong>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <select onchange="mudarTurmaEducando('${edu.id}', this.value)" style="padding:5px 10px; font-size:0.9em;">
                            <option value="">Mover para turma...</option>
                            ${dados.turmas.filter(t => t !== turma).map(t => `<option value="${t}">${t}</option>`).join('')}
                        </select>
                        <button class="btn btn-danger btn-small" onclick="remover('${edu.id}')">Excluir</button>
                    </div>
                </div>
                <div style="overflow-x:auto">
                    <table>
                        <thead><tr><th>Crit√©rio</th>${ETAPAS.map(et => `<th>${et}</th>`).join('')}</tr></thead>
                        <tbody>
                            ${INDICADORES.map(ind => `
                                <tr><td>${ind}</td>${ETAPAS.map(et => `<td><select onchange="salvarNota('${edu.id}','${et}','${ind}',this.value)"><option value="0">-</option>${[1,2,3,4].map(n => `<option value="${n}" ${(dados.avaliacoes[edu.id] && dados.avaliacoes[edu.id][et] && dados.avaliacoes[edu.id][et][ind] == n) ? 'selected' : ''}>${n}</option>`).join('')}</select></td>`).join('')}</tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `).join('');
    }

    function salvarNota(id, et, ind, val) {
        if(!dados.avaliacoes[id]) dados.avaliacoes[id] = { 'Diagn√≥stica':{}, 'Processo':{}, 'Final':{} };
        if(!dados.avaliacoes[id][et]) dados.avaliacoes[id][et] = {};
        dados.avaliacoes[id][et][ind] = parseInt(val);
        
        // Salva no Supabase
        salvarAvaliacaoSupabase(id, et);
    }

    async function salvarAvaliacaoSupabase(educandoId, etapa) {
        try {
            const avaliacaoLocal = dados.avaliacoes[educandoId][etapa];
            
            const avaliacaoData = {
                educando_id: educandoId,
                etapa: etapa,
                leitura: avaliacaoLocal['Leitura'] || 0,
                escrita: avaliacaoLocal['Escrita'] || 0,
                socializacao: avaliacaoLocal['Socializa√ß√£o'] || 0,
                participacao: avaliacaoLocal['Participa√ß√£o'] || 0,
                autonomia: avaliacaoLocal['Autonomia'] || 0,
                raciocinio_logico: avaliacaoLocal['Racioc√≠nio L√≥gico'] || 0
            };
            
            // Verifica se j√° existe
            const { data: existe } = await supabase
                .from('avaliacoes')
                .select('id')
                .eq('educando_id', educandoId)
                .eq('etapa', etapa)
                .single();
            
            if (existe) {
                // Atualiza
                const { error } = await supabase
                    .from('avaliacoes')
                    .update(avaliacaoData)
                    .eq('id', existe.id);
                
                if (error) throw error;
            } else {
                // Insere
                const { error } = await supabase
                    .from('avaliacoes')
                    .insert([avaliacaoData]);
                
                if (error) throw error;
            }
        } catch (erro) {
            console.error('Erro ao salvar avalia√ß√£o:', erro);
            mostrarNotificacao('Erro', 'Erro ao salvar nota: ' + erro.message, 'error');
        }
    }

    function atualizarGrafico() {
        const canvas = document.getElementById('graficoIndicadores');
        if (!canvas || !window.Chart) return;
        
        const ctx = canvas.getContext('2d');
        
        // Obt√©m turmas selecionadas
        const turmasSelecionadas = Array.from(document.querySelectorAll('.checkbox-turma:checked')).map(cb => cb.value);
        
        // Obt√©m etapas selecionadas
        const etapasSelecionadas = Array.from(document.querySelectorAll('.checkbox-etapa:checked')).map(cb => cb.value);
        
        if(turmasSelecionadas.length === 0) {
            if(graficoInstance) graficoInstance.destroy();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.font = '16px sans-serif';
            ctx.fillStyle = '#9ca3af';
            ctx.textAlign = 'center';
            ctx.fillText('Selecione ao menos uma turma', canvas.width/2, canvas.height/2);
            return;
        }
        
        if(etapasSelecionadas.length === 0) {
            if(graficoInstance) graficoInstance.destroy();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.font = '16px sans-serif';
            ctx.fillStyle = '#9ca3af';
            ctx.textAlign = 'center';
            ctx.fillText('Selecione ao menos uma etapa', canvas.width/2, canvas.height/2);
            return;
        }
        
        const datasets = [];
        let corIndex = 0;
        
        // Para cada turma e etapa selecionada, cria um dataset
        turmasSelecionadas.forEach(turma => {
            etapasSelecionadas.forEach(etapa => {
                const medias = INDICADORES.map(ind => {
                    const notas = dados.educandos
                        .filter(e => e.turma === turma)
                        .map(e => (dados.avaliacoes[e.id] && dados.avaliacoes[e.id][etapa]) ? dados.avaliacoes[e.id][etapa][ind] : 0)
                        .filter(n => n > 0);
                    return notas.length ? (notas.reduce((a,b)=>a+b,0)/notas.length).toFixed(2) : 0;
                });
                
                const cor = CORES_TURMAS[corIndex % CORES_TURMAS.length];
                datasets.push({
                    label: `${turma} - ${etapa}`,
                    data: medias,
                    borderColor: cor,
                    backgroundColor: hexToRgba(cor, 0.2),
                    fill: true,
                    tension: 0.3
                });
                corIndex++;
            });
        });
        
        if(graficoInstance) graficoInstance.destroy();
        graficoInstance = new Chart(ctx, {
            type: document.getElementById('tipoGrafico').value,
            data: { labels: INDICADORES, datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, max: 4 },
                    r: { beginAtZero: true, max: 4 }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                }
            }
        });
    }

    function atualizarCheckboxesTurmas() {
        const container = document.getElementById('checkboxTurmas');
        if(!container) return;
        
        if(dados.turmas.length === 0) {
            container.innerHTML = '<p style="color: #9ca3af; font-style: italic;">Nenhuma turma cadastrada</p>';
            return;
        }
        
        container.innerHTML = dados.turmas.sort().map(turma => `
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; background: white; padding: 8px 12px; border-radius: 8px; border: 2px solid #e5e7eb;">
                <input type="checkbox" class="checkbox-turma" value="${turma}" onchange="validarSelecaoTurmas(); atualizarGrafico()">
                <span>${turma}</span>
            </label>
        `).join('');
        
        // Seleciona a primeira turma por padr√£o se houver
        if(dados.turmas.length > 0) {
            const primeiro = container.querySelector('.checkbox-turma');
            if(primeiro) primeiro.checked = true;
        }
    }

    function validarSelecaoTurmas() {
        const checkboxes = document.querySelectorAll('.checkbox-turma');
        const selecionados = Array.from(checkboxes).filter(cb => cb.checked);
        
        if(selecionados.length >= 4) {
            checkboxes.forEach(cb => {
                if(!cb.checked) cb.disabled = true;
            });
        } else {
            checkboxes.forEach(cb => cb.disabled = false);
        }
    }

    function selecionarTodasTurmas() {
        const checkboxes = document.querySelectorAll('.checkbox-turma');
        const quantidadeMaxima = Math.min(checkboxes.length, 4);
        
        checkboxes.forEach((cb, index) => {
            cb.checked = index < quantidadeMaxima;
        });
        
        validarSelecaoTurmas();
        atualizarGrafico();
    }

    function limparSelecaoTurmas() {
        document.querySelectorAll('.checkbox-turma').forEach(cb => {
            cb.checked = false;
            cb.disabled = false;
        });
        atualizarGrafico();
    }

    function exportarBackup() {
        mostrarNotificacao('Exportando', 'Gerando arquivo de backup...', 'info');
        
        let csv = 'ID;NOME;TURMA;ETAPA;' + INDICADORES.join(';') + '\n';
        dados.educandos.forEach(e => ETAPAS.forEach(et => {
            const notas = INDICADORES.map(ind => (dados.avaliacoes[e.id] && dados.avaliacoes[e.id][et]) ? dados.avaliacoes[e.id][et][ind] : 0);
            csv += `${e.id};${e.nome};${e.turma};${et};${notas.join(';')}\n`;
        }));
        const a = document.createElement('a'); 
        a.href = URL.createObjectURL(new Blob(["\ufeff", csv], { type: 'text/csv' })); 
        a.download = `backup_crescendo_juntos_${new Date().toISOString().split('T')[0]}.csv`; 
        a.click();
        
        mostrarNotificacao('Backup Exportado', 'Arquivo CSV gerado com sucesso!', 'success');
    }

    async function processarListaAlunos(input) {
        const file = input.files[0];
        if(!file) return;
        
        const nomeArquivo = file.name.toLowerCase();
        const isExcel = nomeArquivo.endsWith('.xls') || nomeArquivo.endsWith('.xlsx');
        
        mostrarNotificacao('Processando', 'Importando lista de alunos...', 'info');
        
        if(isExcel) {
            // Processa Excel
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const primeiraAba = workbook.Sheets[workbook.SheetNames[0]];
                    const linhas = XLSX.utils.sheet_to_json(primeiraAba, { header: 1 });
                    
                    if(linhas.length === 0) {
                        mostrarNotificacao('Aviso', 'Arquivo vazio!', 'warning');
                        return;
                    }
                    
                    const primeiraLinha = linhas[0].map(c => String(c).toUpperCase());
                    const temCabecalho = primeiraLinha.some(c => c.includes('NOME')) && primeiraLinha.some(c => c.includes('TURMA'));
                    const inicio = temCabecalho ? 1 : 0;
                    
                    const novosEducandos = [];
                    linhas.slice(inicio).forEach(linha => {
                        if(linha.length >= 2 && linha[0] && linha[1]) {
                            const nome = String(linha[0]).trim();
                            const turma = String(linha[1]).trim();
                            
                            if(nome && turma) {
                                const id = "ID" + Date.now() + "_" + Math.random().toString(36).substr(2, 9);
                                novosEducandos.push({ id, nome, turma });
                            }
                        }
                    });
                    
                    if(novosEducandos.length > 0) {
                        // Insere em lote no Supabase
                        const { error } = await supabase
                            .from('educandos')
                            .insert(novosEducandos);
                        
                        if (error) throw error;
                        
                        // Atualiza dados locais
                        dados.educandos.push(...novosEducandos);
                        novosEducandos.forEach(edu => {
                            if(!dados.turmas.includes(edu.turma)) dados.turmas.push(edu.turma);
                            dados.avaliacoes[edu.id] = { 'Diagn√≥stica':{}, 'Processo':{}, 'Final':{} };
                        });
                        
                        atualizarFiltrosTurma();
                        atualizarAbaAtiva();
                        mostrarNotificacao('Importa√ß√£o Conclu√≠da', `${novosEducandos.length} aluno${novosEducandos.length !== 1 ? 's' : ''} importado${novosEducandos.length !== 1 ? 's' : ''} com sucesso!`, 'success');
                    } else {
                        mostrarNotificacao('Erro na Importa√ß√£o', 'Nenhum aluno v√°lido encontrado no arquivo.', 'error');
                    }
                } catch(erro) {
                    console.error('Erro:', erro);
                    mostrarNotificacao('Erro', 'Erro ao processar arquivo: ' + erro.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        } else {
            // Processa CSV
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const linhas = e.target.result.split('\n').filter(l => l.trim());
                    if(linhas.length === 0) {
                        mostrarNotificacao('Aviso', 'Arquivo vazio!', 'warning');
                        return;
                    }
                    
                    const primeiraLinha = linhas[0].toUpperCase();
                    const temCabecalho = primeiraLinha.includes('NOME') && primeiraLinha.includes('TURMA');
                    const inicio = temCabecalho ? 1 : 0;
                    
                    const novosEducandos = [];
                    linhas.slice(inicio).forEach(linha => {
                        const partes = linha.split(';').map(p => p.trim());
                        if(partes.length >= 2 && partes[0] && partes[1]) {
                            const nome = partes[0];
                            const turma = partes[1];
                            const id = "ID" + Date.now() + "_" + Math.random().toString(36).substr(2, 9);
                            novosEducandos.push({ id, nome, turma });
                        }
                    });
                    
                    if(novosEducandos.length > 0) {
                        // Insere em lote no Supabase
                        const { error } = await supabase
                            .from('educandos')
                            .insert(novosEducandos);
                        
                        if (error) throw error;
                        
                        // Atualiza dados locais
                        dados.educandos.push(...novosEducandos);
                        novosEducandos.forEach(edu => {
                            if(!dados.turmas.includes(edu.turma)) dados.turmas.push(edu.turma);
                            dados.avaliacoes[edu.id] = { 'Diagn√≥stica':{}, 'Processo':{}, 'Final':{} };
                        });
                        
                        atualizarFiltrosTurma();
                        atualizarAbaAtiva();
                        mostrarNotificacao('Importa√ß√£o Conclu√≠da', `${novosEducandos.length} aluno${novosEducandos.length !== 1 ? 's' : ''} importado${novosEducandos.length !== 1 ? 's' : ''} com sucesso!`, 'success');
                    } else {
                        mostrarNotificacao('Erro na Importa√ß√£o', 'Nenhum aluno v√°lido encontrado no arquivo.', 'error');
                    }
                } catch(erro) {
                    console.error('Erro:', erro);
                    mostrarNotificacao('Erro', 'Erro ao processar arquivo: ' + erro.message, 'error');
                }
            };
            reader.readAsText(file);
        }
        input.value = '';
    }

    async function processarBackup(input) {
        const file = input.files[0];
        if(!file) return;
        
        const nomeArquivo = file.name.toLowerCase();
        const isExcel = nomeArquivo.endsWith('.xls') || nomeArquivo.endsWith('.xlsx');
        
        mostrarNotificacao('Processando', 'Restaurando backup...', 'info');
        
        if(isExcel) {
            // Processa Excel
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const primeiraAba = workbook.Sheets[workbook.SheetNames[0]];
                    const linhas = XLSX.utils.sheet_to_json(primeiraAba, { header: 1 });
                    
                    if(linhas.length > 0 && linhas[0].some(c => String(c).toUpperCase().includes('ETAPA'))) {
                        await restaurarBackupCompleto(linhas);
                    } else {
                        mostrarNotificacao('Erro', 'Arquivo de backup inv√°lido!', 'error');
                    }
                } catch(erro) {
                    console.error('Erro:', erro);
                    mostrarNotificacao('Erro', 'Erro ao processar arquivo: ' + erro.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        } else {
            // Processa CSV
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const linhas = e.target.result.split('\n').filter(l => l.trim());
                    if(linhas.length > 0 && linhas[0].toUpperCase().includes('ETAPA')) {
                        // Converte CSV para formato de linhas
                        const linhasArray = linhas.map(l => l.split(';'));
                        await restaurarBackupCompleto(linhasArray);
                    } else {
                        mostrarNotificacao('Erro', 'Arquivo de backup inv√°lido!', 'error');
                    }
                } catch(erro) {
                    console.error('Erro:', erro);
                    mostrarNotificacao('Erro', 'Erro ao processar arquivo: ' + erro.message, 'error');
                }
            };
            reader.readAsText(file);
        }
        input.value = '';
    }

    async function restaurarBackupCompleto(linhas) {
        try {
            // Limpa dados atuais
            await supabase.from('avaliacoes').delete().neq('id', 0);
            await supabase.from('educandos').delete().neq('id', '');
            
            const educandosMap = new Map();
            const avaliacoesLista = [];
            
            // Processa linhas (pula cabe√ßalho)
            linhas.slice(1).forEach(linha => {
                if(linha.length > 3) {
                    const id = String(linha[0]);
                    const nome = String(linha[1]);
                    const turma = String(linha[2]);
                    const etapa = String(linha[3]);
                    
                    // Adiciona educando se ainda n√£o existe
                    if(!educandosMap.has(id)) {
                        educandosMap.set(id, { id, nome, turma });
                    }
                    
                    // Cria objeto de avalia√ß√£o
                    const avaliacao = {
                        educando_id: id,
                        etapa: etapa,
                        leitura: parseInt(linha[4]) || 0,
                        escrita: parseInt(linha[5]) || 0,
                        socializacao: parseInt(linha[6]) || 0,
                        participacao: parseInt(linha[7]) || 0,
                        autonomia: parseInt(linha[8]) || 0,
                        raciocinio_logico: parseInt(linha[9]) || 0
                    };
                    
                    // S√≥ adiciona se tiver pelo menos uma nota diferente de 0
                    if(avaliacao.leitura || avaliacao.escrita || avaliacao.socializacao || 
                       avaliacao.participacao || avaliacao.autonomia || avaliacao.raciocinio_logico) {
                        avaliacoesLista.push(avaliacao);
                    }
                }
            });
            
            // Insere educandos
            const educandosArray = Array.from(educandosMap.values());
            if(educandosArray.length > 0) {
                const { error: erroEdu } = await supabase
                    .from('educandos')
                    .insert(educandosArray);
                
                if (erroEdu) throw erroEdu;
            }
            
            // Insere avalia√ß√µes em lotes de 100
            if(avaliacoesLista.length > 0) {
                for(let i = 0; i < avaliacoesLista.length; i += 100) {
                    const lote = avaliacoesLista.slice(i, i + 100);
                    const { error: erroAval } = await supabase
                        .from('avaliacoes')
                        .insert(lote);
                    
                    if (erroAval) throw erroAval;
                }
            }
            
            // Recarrega dados
            await carregarDados();
            atualizarFiltrosTurma();
            atualizarAbaAtiva();
            
            mostrarNotificacao('Backup Restaurado', 
                `${educandosArray.length} alunos e ${avaliacoesLista.length} avalia√ß√µes restauradas com sucesso!`, 
                'success');
        } catch(erro) {
            console.error('Erro ao restaurar backup:', erro);
            mostrarNotificacao('Erro', 'Erro ao restaurar backup: ' + erro.message, 'error');
        }
    }

    async function adicionarEducando() {
        const nome = await perguntar('Nome do Aluno', 'Digite o nome completo do aluno:', 'Ex: Jo√£o Silva');
        if(!nome) return;
        
        let turma = '';
        
        if(dados.turmas.length > 0) {
            const opcao = await confirmar(
                'Escolher Turma', 
                `Deseja adicionar "${nome}" em uma turma existente?\n\nClique CONFIRMAR para escolher uma turma existente\nClique CANCELAR para criar uma nova turma`, 
                'üìö'
            );
            
            if(opcao) {
                // Escolher turma existente
                const listaTurmas = dados.turmas.sort().map((t, i) => `${i+1}. ${t}`).join('\n');
                const escolha = await perguntar(
                    'Selecione a Turma', 
                    `Digite o n√∫mero da turma:\n\n${listaTurmas}`,
                    'Digite o n√∫mero...'
                );
                
                if(escolha && !isNaN(escolha)) {
                    const index = parseInt(escolha) - 1;
                    if(index >= 0 && index < dados.turmas.length) {
                        turma = dados.turmas[index];
                    }
                }
            } else {
                // Criar nova turma
                turma = await perguntar('Nova Turma', 'Digite o nome da nova turma:', 'Ex: 3¬∫ Ano A');
            }
        } else {
            // N√£o h√° turmas, criar a primeira
            turma = await perguntar('Nome da Turma', 'Digite o nome da primeira turma:', 'Ex: 3¬∫ Ano A');
        }
        
        if(turma) {
            await adicionarEducandoSupabase(nome, turma);
        }
    }

    async function adicionarEducandoSupabase(nome, turma) {
        try {
            const id = "ID" + Date.now() + "_" + Math.random().toString(36).substr(2, 9);
            
            const { error } = await supabase
                .from('educandos')
                .insert([{ id, nome, turma }]);
            
            if (error) throw error;
            
            // Atualiza local
            dados.educandos.push({id, nome, turma});
            if(!dados.turmas.includes(turma)) dados.turmas.push(turma);
            dados.avaliacoes[id] = { 'Diagn√≥stica':{}, 'Processo':{}, 'Final':{} };
            
            atualizarFiltrosTurma(); 
            atualizarListaEducandos();
            atualizarVisaoGeral();
            atualizarCheckboxesTurmas();
            
            mostrarNotificacao('Aluno Adicionado', `${nome} foi adicionado √† turma ${turma}!`, 'success');
        } catch (erro) {
            console.error('Erro ao adicionar educando:', erro);
            mostrarNotificacao('Erro', 'Erro ao adicionar aluno: ' + erro.message, 'error');
        }
    }

    async function mudarTurmaEducando(id, novaTurma) {
        if(!novaTurma) return;
        
        const educando = dados.educandos.find(e => e.id === id);
        if(!educando) return;
        
        const turmaAntiga = educando.turma;
        
        const confirmado = await confirmar('Mover Aluno', `Mover "${educando.nome}" de "${turmaAntiga}" para "${novaTurma}"?`, 'üìö');
        
        if(confirmado) {
            try {
                const { error } = await supabase
                    .from('educandos')
                    .update({ turma: novaTurma })
                    .eq('id', id);
                
                if (error) throw error;
                
                educando.turma = novaTurma;
                atualizarListaEducandos();
                atualizarVisaoGeral();
                mostrarNotificacao('Aluno Movido', `Aluno movido com sucesso para ${novaTurma}!`, 'success');
            } catch (erro) {
                console.error('Erro ao mover educando:', erro);
                mostrarNotificacao('Erro', 'Erro ao mover aluno: ' + erro.message, 'error');
                atualizarListaEducandos();
            }
        } else {
            atualizarListaEducandos();
        }
    }

    async function remover(id) {
        const confirmado = await confirmar('Remover Aluno', 'Tem certeza que deseja remover este aluno?', 'üóëÔ∏è');
        
        if(confirmado) {
            try {
                // Remove avalia√ß√µes primeiro
                const { error: erroAval } = await supabase
                    .from('avaliacoes')
                    .delete()
                    .eq('educando_id', id);
                
                if (erroAval) throw erroAval;
                
                // Remove educando
                const { error: erroEdu } = await supabase
                    .from('educandos')
                    .delete()
                    .eq('id', id);
                
                if (erroEdu) throw erroEdu;
                
                dados.educandos = dados.educandos.filter(e => e.id !== id); 
                delete dados.avaliacoes[id]; 
                atualizarListaEducandos();
                atualizarVisaoGeral();
                mostrarNotificacao('Aluno Removido', 'Aluno removido com sucesso!', 'success');
            } catch (erro) {
                console.error('Erro ao remover educando:', erro);
                mostrarNotificacao('Erro', 'Erro ao remover aluno: ' + erro.message, 'error');
            }
        } 
    }

    function gerenciarTurmas() {
        document.getElementById('modalTurmas').classList.add('active');
        atualizarListaTurmasModal();
    }

    function fecharModalTurmas() {
        document.getElementById('modalTurmas').classList.remove('active');
        document.getElementById('inputNovaTurma').value = '';
    }

    function atualizarListaTurmasModal() {
        const container = document.getElementById('listaTurmasModal');
        if(dados.turmas.length === 0) {
            container.innerHTML = '<p class="empty-state">Nenhuma turma cadastrada</p>';
            return;
        }
        
        container.innerHTML = dados.turmas.sort().map(turma => {
            const qtdAlunos = dados.educandos.filter(e => e.turma === turma).length;
            const temAlunos = qtdAlunos > 0;
            
            return `
                <div class="turma-item">
                    <div>
                        <strong>${turma}</strong>
                        <span style="color: #6b7280; font-size: 0.9em; margin-left: 10px;">(${qtdAlunos} aluno${qtdAlunos !== 1 ? 's' : ''})</span>
                    </div>
                    ${!temAlunos ? `<button class="btn btn-danger btn-small" onclick="excluirTurma('${turma}')">Excluir</button>` : '<span style="color: #9ca3af; font-size: 0.85em;">Tem alunos</span>'}
                </div>
            `;
        }).join('');
    }

    async function adicionarNovaTurma() {
        const input = document.getElementById('inputNovaTurma');
        const nomeTurma = input.value.trim();
        
        if(!nomeTurma) {
            mostrarNotificacao('Aviso', 'Digite o nome da turma!', 'warning');
            return;
        }
        
        if(dados.turmas.includes(nomeTurma)) {
            mostrarNotificacao('Aviso', 'Esta turma j√° existe!', 'warning');
            return;
        }
        
        dados.turmas.push(nomeTurma);
        input.value = '';
        atualizarListaTurmasModal();
        atualizarFiltrosTurma();
        atualizarCheckboxesTurmas();
        mostrarNotificacao('Turma Criada', `Turma "${nomeTurma}" criada com sucesso!`, 'success');
    }

    async function excluirTurma(turma) {
        const qtdAlunos = dados.educandos.filter(e => e.turma === turma).length;
        
        if(qtdAlunos > 0) {
            mostrarNotificacao('N√£o Permitido', `N√£o √© poss√≠vel excluir a turma "${turma}" pois ela possui ${qtdAlunos} aluno${qtdAlunos !== 1 ? 's' : ''} cadastrado${qtdAlunos !== 1 ? 's' : ''}!`, 'error');
            return;
        }
        
        const confirmado = await confirmar('Excluir Turma', `Tem certeza que deseja excluir a turma "${turma}"?`, 'üóëÔ∏è');
        
        if(confirmado) {
            dados.turmas = dados.turmas.filter(t => t !== turma);
            atualizarListaTurmasModal();
            atualizarFiltrosTurma();
            atualizarCheckboxesTurmas();
            atualizarVisaoGeral();
            mostrarNotificacao('Turma Exclu√≠da', `Turma "${turma}" exclu√≠da com sucesso!`, 'success');
        }
    }

    // Fecha modal ao clicar fora
    document.addEventListener('click', function(e) {
        const modalTurmas = document.getElementById('modalTurmas');
        const modalExportar = document.getElementById('modalExportar');
        const modalConfirm = document.getElementById('modalConfirm');
        const modalPrompt = document.getElementById('modalPrompt');
        
        if(e.target === modalTurmas) {
            fecharModalTurmas();
        }
        if(e.target === modalExportar) {
            fecharModalExportar();
        }
        if(e.target === modalConfirm) {
            confirmarAcao(false);
        }
        if(e.target === modalPrompt) {
            confirmarPrompt(null);
        }
    });

    function abrirModalExportar() {
        if(!graficoInstance) {
            mostrarNotificacao('Aviso', 'Nenhum gr√°fico para exportar. Configure e visualize um gr√°fico primeiro.', 'warning');
            return;
        }
        document.getElementById('modalExportar').classList.add('active');
    }

    function fecharModalExportar() {
        document.getElementById('modalExportar').classList.remove('active');
    }

    function exportarGrafico(formato) {
        if(!graficoInstance) {
            mostrarNotificacao('Erro', 'Nenhum gr√°fico para exportar!', 'error');
            return;
        }

        const canvas = document.getElementById('graficoIndicadores');
        const dataAtual = new Date().toISOString().split('T')[0];
        const nomeArquivo = `grafico_crescendo_juntos_${dataAtual}`;

        try {
            if(formato === 'png') {
                // Exportar como PNG
                canvas.toBlob(function(blob) {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${nomeArquivo}.png`;
                    a.click();
                    URL.revokeObjectURL(url);
                    fecharModalExportar();
                    mostrarNotificacao('Exporta√ß√£o Conclu√≠da', 'Gr√°fico exportado como PNG com sucesso!', 'success');
                });
            } else if(formato === 'jpg') {
                // Exportar como JPG com fundo branco
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = canvas.width;
                tempCanvas.height = canvas.height;
                const tempCtx = tempCanvas.getContext('2d');
                
                // Preenche com branco
                tempCtx.fillStyle = '#FFFFFF';
                tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                
                // Desenha o gr√°fico por cima
                tempCtx.drawImage(canvas, 0, 0);
                
                tempCanvas.toBlob(function(blob) {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${nomeArquivo}.jpg`;
                    a.click();
                    URL.revokeObjectURL(url);
                    fecharModalExportar();
                    mostrarNotificacao('Exporta√ß√£o Conclu√≠da', 'Gr√°fico exportado como JPG com sucesso!', 'success');
                }, 'image/jpeg', 0.95);
            } else if(formato === 'pdf') {
                // Exportar como PDF
                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                
                // Cria PDF em paisagem para melhor visualiza√ß√£o
                const pdf = new jsPDF({
                    orientation: 'landscape',
                    unit: 'mm',
                    format: 'a4'
                });

                // Dimens√µes do PDF A4 em paisagem
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                
                // Calcula dimens√µes mantendo propor√ß√£o
                const canvasRatio = canvas.width / canvas.height;
                let imgWidth = pdfWidth - 20; // margem de 10mm em cada lado
                let imgHeight = imgWidth / canvasRatio;
                
                // Se a altura ultrapassar a p√°gina, ajusta
                if(imgHeight > pdfHeight - 40) {
                    imgHeight = pdfHeight - 40;
                    imgWidth = imgHeight * canvasRatio;
                }

                const x = (pdfWidth - imgWidth) / 2;
                const y = 20;

                // Adiciona t√≠tulo
                pdf.setFontSize(16);
                pdf.text('Crescendo Juntos - An√°lise de Evolu√ß√£o Pedag√≥gica', pdfWidth / 2, 12, { align: 'center' });
                
                // Adiciona o gr√°fico
                pdf.addImage(imgData, 'PNG', x, y, imgWidth, imgHeight);
                
                // Adiciona data no rodap√©
                pdf.setFontSize(10);
                pdf.text(`Gerado em: ${new Date().toLocaleDateString('pt-BR')}`, pdfWidth / 2, pdfHeight - 10, { align: 'center' });
                
                // Salva o PDF
                pdf.save(`${nomeArquivo}.pdf`);
                fecharModalExportar();
                mostrarNotificacao('Exporta√ß√£o Conclu√≠da', 'Gr√°fico exportado como PDF com sucesso!', 'success');
            }
        } catch(erro) {
            mostrarNotificacao('Erro na Exporta√ß√£o', erro.message, 'error');
            console.error(erro);
        }
    }

    async function limparTudo() {
        const confirmado = await confirmar(
            'Resetar Sistema', 
            '‚ö†Ô∏è ATEN√á√ÉO: Isso vai apagar TODOS os dados do sistema no servidor!\n\nDeseja continuar?',
            '‚ö†Ô∏è'
        );
        
        if(confirmado) {
            try {
                // Deleta todas as avalia√ß√µes
                const { error: erroAval } = await supabase
                    .from('avaliacoes')
                    .delete()
                    .neq('id', 0); // Deleta todos
                
                if (erroAval) throw erroAval;
                
                // Deleta todos os educandos
                const { error: erroEdu } = await supabase
                    .from('educandos')
                    .delete()
                    .neq('id', ''); // Deleta todos
                
                if (erroEdu) throw erroEdu;
                
                sessionStorage.removeItem('projeto_auth');
                location.reload();
            } catch (erro) {
                console.error('Erro ao resetar sistema:', erro);
                mostrarNotificacao('Erro', 'Erro ao resetar sistema: ' + erro.message, 'error');
            }
        } 
    }
    
    function hexToRgba(hex, a) { 
        const r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16); 
        return `rgba(${r},${g},${b},${a})`; 
    }

    function atualizarFiltrosTurma() {
        document.querySelectorAll('.filtro-turma').forEach(sel => {
            const v = sel.value;
            sel.innerHTML = '<option value="">Turma...</option>' + (sel.id !== 'turmaAtivaAvaliacao' ? '<option value="todas">Todas</option>' : '');
            dados.turmas.sort().forEach(t => sel.innerHTML += `<option value="${t}">${t}</option>`);
            sel.value = v;
        });
    }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Projeto Crescendo Juntos - Sistema Estabilizado</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #f97316;
            --primary-dark: #ea580c;
            --bg-gradient: linear-gradient(135deg, #fbbf24 0%, #f97316 100%);
            --card-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg-gradient); min-height: 100vh; color: #1f2937; }

        /* TELA DE LOGIN */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-gradient); display: flex; justify-content: center; align-items: center; z-index: 9999;
        }
        .login-card {
            background: white; padding: 40px; border-radius: 20px; box-shadow: var(--card-shadow);
            text-align: center; max-width: 400px; width: 90%;
        }
        .login-card h2 { color: var(--primary-dark); margin-bottom: 10px; }
        .login-card input {
            width: 100%; padding: 12px; margin: 15px 0; border: 2px solid #e5e7eb; border-radius: 10px; text-align: center; font-size: 1.1em;
        }

        /* CONTE√öDO PRINCIPAL */
        #main-content { display: none; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header, .tabs, .card { background: white; border-radius: 15px; box-shadow: var(--card-shadow); margin-bottom: 20px; padding: 25px; }
        .header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
        .header h1 { color: #92400e; }
        
        .tabs { display: flex; gap: 10px; padding: 10px 20px; }
        .tab-btn { padding: 12px 25px; border: none; background: transparent; cursor: pointer; font-weight: 600; color: #6b7280; border-bottom: 3px solid transparent; transition: 0.3s; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-small { padding: 5px 10px; font-size: 0.8em; }

        .control-panel { background: #fff7ed; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap; border: 1px solid #ffedd5; }
        
        .educando-row { background: #fafafa; padding: 20px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #e5e7eb; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
        th { background: #f3f4f6; padding: 10px; text-align: left; font-size: 0.85em; color: #4b5563; }
        td { padding: 10px; border-bottom: 1px solid #f3f4f6; }
        
        select { padding: 8px; border-radius: 8px; border: 2px solid #e5e7eb; outline-color: var(--primary); background: white; }
        .chart-container { position: relative; height: 450px; width: 100%; }
        .empty-state { text-align: center; padding: 40px; color: #9ca3af; font-style: italic; }
        
        /* Modal */
        .modal { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-close { cursor: pointer; font-size: 24px; color: #6b7280; }
        .turma-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f9fafb; border-radius: 8px; margin-bottom: 10px; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-card">
        <h2>üîí Acesso Restrito</h2>
        <p style="color: #6b7280; margin-bottom: 20px;">Digite a senha para acessar o sistema</p>
        <input type="password" id="access-key" placeholder="Digite a senha" onkeypress="if(event.key==='Enter') handleLogin()">
        <button class="btn btn-primary" style="width: 100%; justify-content: center;" onclick="handleLogin()">Entrar</button>
        <p id="login-error" style="color: #ef4444; margin-top: 10px; display: none;">Senha incorreta. Tente novamente.</p>
    </div>
</div>

<div id="main-content">
    <div class="container">
        <header class="header">
            <div><h1>Crescendo Juntos</h1><p>An√°lise de Evolu√ß√£o Pedag√≥gica</p></div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="document.getElementById('fileInputLista').click()">üìã Importar Lista</button>
                <button class="btn btn-primary" onclick="document.getElementById('fileInputBackup').click()">üíæ Importar Backup</button>
                <button class="btn btn-success" onclick="exportarBackup()">Exportar Backup</button>
                <button class="btn btn-danger btn-small" onclick="logout()">Sair</button>
                <input type="file" id="fileInputLista" accept=".csv,.xls,.xlsx" style="display:none" onchange="processarListaAlunos(this)">
                <input type="file" id="fileInputBackup" accept=".csv,.xls,.xlsx" style="display:none" onchange="processarBackup(this)">
            </div>
        </header>

        <nav class="tabs">
            <button class="tab-btn active" onclick="mudarAba('visao-geral', this)">Painel de Gr√°ficos</button>
            <button class="tab-btn" onclick="mudarAba('avaliacoes', this)">Lan√ßar Notas (1-4)</button>
        </nav>

        <div id="visao-geral" class="tab-content active">
            <div class="card">
                <h3 style="margin-bottom: 20px;">‚öôÔ∏è Configura√ß√£o de Compara√ß√£o</h3>
                
                <div style="background: #f9fafb; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #374151;">
                            üìä Selecione as Turmas (at√© 4):
                        </label>
                        <div id="checkboxTurmas" style="display: flex; flex-wrap: wrap; gap: 15px;">
                            <!-- Ser√° preenchido dinamicamente -->
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #374151;">
                            üìÖ Selecione as Etapas:
                        </label>
                        <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" class="checkbox-etapa" value="Diagn√≥stica" checked onchange="atualizarGrafico()">
                                <span>Diagn√≥stica</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" class="checkbox-etapa" value="Processo" onchange="atualizarGrafico()">
                                <span>Processo</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" class="checkbox-etapa" value="Final" onchange="atualizarGrafico()">
                                <span>Final</span>
                            </label>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="tipoGrafico" onchange="atualizarGrafico()" style="flex: 1;">
                            <option value="bar">Gr√°fico de Barras</option>
                            <option value="radar">Gr√°fico Radar</option>
                            <option value="line">Gr√°fico de Linhas</option>
                        </select>
                        <button class="btn btn-primary" onclick="selecionarTodasTurmas()">Todas as Turmas</button>
                        <button class="btn btn-danger btn-small" onclick="limparSelecaoTurmas()">Limpar</button>
                    </div>
                </div>
                
                <div class="chart-container"><canvas id="graficoIndicadores"></canvas></div>
            </div>
            <div class="card">
                <h3>Vis√£o geral das turmas</h3>
                <div id="visaoTurmasContainer" class="empty-state">Nenhuma turma cadastrada.</div>
            </div>
        </div>

        <div id="avaliacoes" class="tab-content">
            <div class="card">
                <div class="control-panel">
                    <div style="flex-grow: 1;">
                        <label><strong>Filtrar Turma:</strong></label>
                        <select class="filtro-turma" id="turmaAtivaAvaliacao" onchange="atualizarListaEducandos()"></select>
                    </div>
                    <button class="btn btn-success" onclick="gerenciarTurmas()">üìö Gerenciar Turmas</button>
                    <button class="btn btn-primary" onclick="adicionarEducando()">+ Novo Aluno</button>
                    <button class="btn btn-danger btn-small" onclick="limparTudo()">Resetar Sistema</button>
                </div>
                <div id="educandosContainer"></div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Gerenciamento de Turmas -->
<div id="modalTurmas" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üìö Gerenciar Turmas</h2>
            <span class="modal-close" onclick="fecharModalTurmas()">&times;</span>
        </div>
        
        <div style="margin-bottom: 20px;">
            <label style="display: block; font-weight: 600; margin-bottom: 10px;">Adicionar Nova Turma:</label>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="inputNovaTurma" placeholder="Ex: 3¬∫ Ano A" style="flex: 1; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                <button class="btn btn-primary" onclick="adicionarNovaTurma()">Adicionar</button>
            </div>
        </div>
        
        <div>
            <label style="display: block; font-weight: 600; margin-bottom: 10px;">Turmas Cadastradas:</label>
            <div id="listaTurmasModal"></div>
        </div>
    </div>
</div>

<script>
    const CHAVE_MESTRA = "Z2lyYXNzb2xfMTIz"; 

    function handleLogin() {
        const campo = document.getElementById('access-key');
        const senhaDigitada = campo.value.trim();
        if (btoa(senhaDigitada) === CHAVE_MESTRA) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            sessionStorage.setItem('projeto_auth', 'true');
            atualizarFiltrosTurma();
            atualizarAbaAtiva();
        } else {
            document.getElementById('login-error').style.display = 'block';
            campo.value = '';
        }
    }

    if(sessionStorage.getItem('projeto_auth') === 'true') {
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            atualizarFiltrosTurma();
            atualizarAbaAtiva();
        });
    }

    const INDICADORES = ['Leitura', 'Escrita', 'Socializa√ß√£o', 'Participa√ß√£o', 'Autonomia', 'Racioc√≠nio L√≥gico'];
    const ETAPAS = ['Diagn√≥stica', 'Processo', 'Final'];
    const CORES = { 'Diagn√≥stica': '#f59e0b', 'Processo': '#3b82f6', 'Final': '#10b981' };
    const CORES_TURMAS = ['#ef4444', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316', '#06b6d4'];
    let dados = { educandos: [], turmas: [], avaliacoes: {} };
    let graficoInstance = null;

    window.onload = () => {
        const salvos = localStorage.getItem('crescendo_dados_v1');
        if (salvos) dados = JSON.parse(salvos);
        if(sessionStorage.getItem('projeto_auth') === 'true') {
            atualizarFiltrosTurma();
            atualizarAbaAtiva();
        }
    };

    function logout() { sessionStorage.removeItem('projeto_auth'); location.reload(); }
    function salvar() { localStorage.setItem('crescendo_dados_v1', JSON.stringify(dados)); }

    function mudarAba(aba, btn) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(aba).classList.add('active');
        btn.classList.add('active');
        atualizarAbaAtiva();
    }

    function atualizarVisaoGeral() {
        const container = document.getElementById('visaoTurmasContainer');
        if(!container) return;
        if(!dados.turmas || dados.turmas.length === 0) {
            container.innerHTML = '<div class="empty-state">Nenhuma turma cadastrada.</div>';
            return;
        }
        container.innerHTML = dados.turmas.sort().map(t => {
            const count = dados.educandos.filter(e => e.turma === t).length;
            return `<div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #f3f4f6;"><strong>${t}</strong><span>${count} aluno${count !== 1 ? 's' : ''}</span></div>`;
        }).join('');
    }

    function atualizarAbaAtiva() {
        const abaVisaoGeral = document.getElementById('visao-geral');
        const abaAvaliacoes = document.getElementById('avaliacoes');

        if (abaVisaoGeral.classList.contains('active')) {
            atualizarCheckboxesTurmas();
            atualizarGrafico();
            atualizarVisaoGeral();
        }

        if (abaAvaliacoes.classList.contains('active')) {
            atualizarListaEducandos();
        }
    }

    function atualizarListaEducandos() {
        const turma = document.getElementById('turmaAtivaAvaliacao').value;
        const container = document.getElementById('educandosContainer');
        if (!turma) { container.innerHTML = '<div class="empty-state">Selecione uma turma acima.</div>'; return; }
        const lista = dados.educandos.filter(e => e.turma === turma);
        
        if(lista.length === 0) {
            container.innerHTML = '<div class="empty-state">Nenhum aluno cadastrado nesta turma.</div>';
            return;
        }
        
        container.innerHTML = lista.map(edu => `
            <div class="educando-row">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; flex-wrap:wrap; gap:10px;">
                    <strong style="flex-grow:1;">${edu.nome}</strong>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <select onchange="mudarTurmaEducando('${edu.id}', this.value)" style="padding:5px 10px; font-size:0.9em;">
                            <option value="">Mover para turma...</option>
                            ${dados.turmas.filter(t => t !== turma).map(t => `<option value="${t}">${t}</option>`).join('')}
                        </select>
                        <button class="btn btn-danger btn-small" onclick="remover('${edu.id}')">Excluir</button>
                    </div>
                </div>
                <div style="overflow-x:auto">
                    <table>
                        <thead><tr><th>Crit√©rio</th>${ETAPAS.map(et => `<th>${et}</th>`).join('')}</tr></thead>
                        <tbody>
                            ${INDICADORES.map(ind => `
                                <tr><td>${ind}</td>${ETAPAS.map(et => `<td><select onchange="salvarNota('${edu.id}','${et}','${ind}',this.value)"><option value="0">-</option>${[1,2,3,4].map(n => `<option value="${n}" ${(dados.avaliacoes[edu.id] && dados.avaliacoes[edu.id][et] && dados.avaliacoes[edu.id][et][ind] == n) ? 'selected' : ''}>${n}</option>`).join('')}</select></td>`).join('')}</tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `).join('');
    }

    function salvarNota(id, et, ind, val) { 
        if(!dados.avaliacoes[id]) dados.avaliacoes[id] = { 'Diagn√≥stica':{}, 'Processo':{}, 'Final':{} };
        if(!dados.avaliacoes[id][et]) dados.avaliacoes[id][et] = {};
        dados.avaliacoes[id][et][ind] = parseInt(val); 
        salvar(); 
    }

    function atualizarGrafico() {
        const canvas = document.getElementById('graficoIndicadores');
        if (!canvas || !window.Chart) return;
        
        const ctx = canvas.getContext('2d');
        
        // Obt√©m turmas selecionadas
        const turmasSelecionadas = Array.from(document.querySelectorAll('.checkbox-turma:checked')).map(cb => cb.value);
        
        // Obt√©m etapas selecionadas
        const etapasSelecionadas = Array.from(document.querySelectorAll('.checkbox-etapa:checked')).map(cb => cb.value);
        
        if(turmasSelecionadas.length === 0) {
            if(graficoInstance) graficoInstance.destroy();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.font = '16px sans-serif';
            ctx.fillStyle = '#9ca3af';
            ctx.textAlign = 'center';
            ctx.fillText('Selecione ao menos uma turma', canvas.width/2, canvas.height/2);
            return;
        }
        
        if(etapasSelecionadas.length === 0) {
            if(graficoInstance) graficoInstance.destroy();
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.font = '16px sans-serif';
            ctx.fillStyle = '#9ca3af';
            ctx.textAlign = 'center';
            ctx.fillText('Selecione ao menos uma etapa', canvas.width/2, canvas.height/2);
            return;
        }
        
        const datasets = [];
        let corIndex = 0;
        
        // Para cada turma e etapa selecionada, cria um dataset
        turmasSelecionadas.forEach(turma => {
            etapasSelecionadas.forEach(etapa => {
                const medias = INDICADORES.map(ind => {
                    const notas = dados.educandos
                        .filter(e => e.turma === turma)
                        .map(e => (dados.avaliacoes[e.id] && dados.avaliacoes[e.id][etapa]) ? dados.avaliacoes[e.id][etapa][ind] : 0)
                        .filter(n => n > 0);
                    return notas.length ? (notas.reduce((a,b)=>a+b,0)/notas.length).toFixed(2) : 0;
                });
                
                const cor = CORES_TURMAS[corIndex % CORES_TURMAS.length];
                datasets.push({
                    label: `${turma} - ${etapa}`,
                    data: medias,
                    borderColor: cor,
                    backgroundColor: hexToRgba(cor, 0.2),
                    fill: true,
                    tension: 0.3
                });
                corIndex++;
            });
        });
        
        if(graficoInstance) graficoInstance.destroy();
        graficoInstance = new Chart(ctx, {
            type: document.getElementById('tipoGrafico').value,
            data: { labels: INDICADORES, datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, max: 4 },
                    r: { beginAtZero: true, max: 4 }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                }
            }
        });
    }

    function atualizarCheckboxesTurmas() {
        const container = document.getElementById('checkboxTurmas');
        if(!container) return;
        
        if(dados.turmas.length === 0) {
            container.innerHTML = '<p style="color: #9ca3af; font-style: italic;">Nenhuma turma cadastrada</p>';
            return;
        }
        
        container.innerHTML = dados.turmas.sort().map(turma => `
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; background: white; padding: 8px 12px; border-radius: 8px; border: 2px solid #e5e7eb;">
                <input type="checkbox" class="checkbox-turma" value="${turma}" onchange="validarSelecaoTurmas(); atualizarGrafico()">
                <span>${turma}</span>
            </label>
        `).join('');
        
        // Seleciona a primeira turma por padr√£o se houver
        if(dados.turmas.length > 0) {
            const primeiro = container.querySelector('.checkbox-turma');
            if(primeiro) primeiro.checked = true;
        }
    }

    function validarSelecaoTurmas() {
        const checkboxes = document.querySelectorAll('.checkbox-turma');
        const selecionados = Array.from(checkboxes).filter(cb => cb.checked);
        
        if(selecionados.length >= 4) {
            checkboxes.forEach(cb => {
                if(!cb.checked) cb.disabled = true;
            });
        } else {
            checkboxes.forEach(cb => cb.disabled = false);
        }
    }

    function selecionarTodasTurmas() {
        const checkboxes = document.querySelectorAll('.checkbox-turma');
        const quantidadeMaxima = Math.min(checkboxes.length, 4);
        
        checkboxes.forEach((cb, index) => {
            cb.checked = index < quantidadeMaxima;
        });
        
        validarSelecaoTurmas();
        atualizarGrafico();
    }

    function limparSelecaoTurmas() {
        document.querySelectorAll('.checkbox-turma').forEach(cb => {
            cb.checked = false;
            cb.disabled = false;
        });
        atualizarGrafico();
    }

    function exportarBackup() {
        let csv = 'ID;NOME;TURMA;ETAPA;' + INDICADORES.join(';') + '\n';
        dados.educandos.forEach(e => ETAPAS.forEach(et => {
            const notas = INDICADORES.map(ind => (dados.avaliacoes[e.id] && dados.avaliacoes[e.id][et]) ? dados.avaliacoes[e.id][et][ind] : 0);
            csv += `${e.id};${e.nome};${e.turma};${et};${notas.join(';')}\n`;
        }));
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob(["\ufeff", csv], { type: 'text/csv' })); a.download = 'backup.csv'; a.click();
    }

    function processarListaAlunos(input) {
        const file = input.files[0];
        if(!file) return;
        
        const nomeArquivo = file.name.toLowerCase();
        const isExcel = nomeArquivo.endsWith('.xls') || nomeArquivo.endsWith('.xlsx');
        
        if(isExcel) {
            // Processa Excel
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const primeiraAba = workbook.Sheets[workbook.SheetNames[0]];
                    const linhas = XLSX.utils.sheet_to_json(primeiraAba, { header: 1 });
                    
                    if(linhas.length === 0) {
                        alert("Arquivo vazio!");
                        return;
                    }
                    
                    // Verifica se tem cabe√ßalho
                    const primeiraLinha = linhas[0].map(c => String(c).toUpperCase());
                    const temCabecalho = primeiraLinha.some(c => c.includes('NOME')) && primeiraLinha.some(c => c.includes('TURMA'));
                    const inicio = temCabecalho ? 1 : 0;
                    
                    let adicionados = 0;
                    linhas.slice(inicio).forEach(linha => {
                        if(linha.length >= 2 && linha[0] && linha[1]) {
                            const nome = String(linha[0]).trim();
                            const turma = String(linha[1]).trim();
                            
                            if(nome && turma) {
                                const id = "ID" + Date.now() + "_" + Math.random().toString(36).substr(2, 9);
                                dados.educandos.push({id, nome, turma});
                                if(!dados.turmas.includes(turma)) dados.turmas.push(turma);
                                dados.avaliacoes[id] = { 'Diagn√≥stica':{}, 'Processo':{}, 'Final':{} };
                                adicionados++;
                            }
                        }
                    });
                    
                    if(adicionados > 0) {
                        salvar(); 
                        atualizarFiltrosTurma();
                        atualizarAbaAtiva();
                        alert(`‚úì ${adicionados} aluno${adicionados !== 1 ? 's' : ''} importado${adicionados !== 1 ? 's' : ''} com sucesso!`);
                    } else {
                        alert("Nenhum aluno v√°lido encontrado no arquivo.\n\nFormato esperado:\nColuna A: NOME\nColuna B: TURMA");
                    }
                } catch(erro) {
                    alert("Erro ao processar arquivo Excel: " + erro.message);
                }
            };
            reader.readAsArrayBuffer(file);
        } else {
            // Processa CSV
            const reader = new FileReader();
            reader.onload = (e) => {
                const linhas = e.target.result.split('\n').filter(l => l.trim());
                if(linhas.length === 0) {
                    alert("Arquivo vazio!");
                    return;
                }
                
                const primeiraLinha = linhas[0].toUpperCase();
                const temCabecalho = primeiraLinha.includes('NOME') && primeiraLinha.includes('TURMA');
                const inicio = temCabecalho ? 1 : 0;
                
                let adicionados = 0;
                linhas.slice(inicio).forEach(linha => {
                    const partes = linha.split(';').map(p => p.trim());
                    if(partes.length >= 2 && partes[0] && partes[1]) {
                        const nome = partes[0];
                        const turma = partes[1];
                        const id = "ID" + Date.now() + "_" + Math.random().toString(36).substr(2, 9);
                        
                        dados.educandos.push({id, nome, turma});
                        if(!dados.turmas.includes(turma)) dados.turmas.push(turma);
                        dados.avaliacoes[id] = { 'Diagn√≥stica':{}, 'Processo':{}, 'Final':{} };
                        adicionados++;
                    }
                });
                
                if(adicionados > 0) {
                    salvar(); 
                    atualizarFiltrosTurma();
                    atualizarAbaAtiva();
                    alert(`‚úì ${adicionados} aluno${adicionados !== 1 ? 's' : ''} importado${adicionados !== 1 ? 's' : ''} com sucesso!`);
                } else {
                    alert("Nenhum aluno v√°lido encontrado no arquivo.\n\nFormato esperado:\nNOME;TURMA\nJo√£o Silva;3¬∫ Ano A");
                }
            };
            reader.readAsText(file);
        }
        input.value = '';
    }

    function processarBackup(input) {
        const file = input.files[0];
        if(!file) return;
        
        const nomeArquivo = file.name.toLowerCase();
        const isExcel = nomeArquivo.endsWith('.xls') || nomeArquivo.endsWith('.xlsx');
        
        if(isExcel) {
            // Processa Excel
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const primeiraAba = workbook.Sheets[workbook.SheetNames[0]];
                    const linhas = XLSX.utils.sheet_to_json(primeiraAba, { header: 1 });
                    
                    if(linhas.length > 0 && linhas[0].some(c => String(c).toUpperCase().includes('ETAPA'))) {
                        dados = { educandos: [], turmas: [], avaliacoes: {} };
                        
                        linhas.slice(1).forEach(linha => {
                            if(linha.length > 3) {
                                const id = String(linha[0]);
                                const nome = String(linha[1]);
                                const turma = String(linha[2]);
                                const etapa = String(linha[3]);
                                
                                if(!dados.avaliacoes[id]) {
                                    dados.educandos.push({id, nome, turma});
                                    if(!dados.turmas.includes(turma)) dados.turmas.push(turma);
                                    dados.avaliacoes[id] = { 'Diagn√≥stica':{}, 'Processo':{}, 'Final':{} };
                                }
                                
                                if(!dados.avaliacoes[id][etapa]) dados.avaliacoes[id][etapa] = {};
                                INDICADORES.forEach((ind, i) => {
                                    dados.avaliacoes[id][etapa][ind] = parseInt(linha[i+4]) || 0;
                                });
                            }
                        });
                        
                        salvar(); 
                        atualizarFiltrosTurma();
                        atualizarAbaAtiva();
                        alert("‚úì Backup importado com sucesso!");
                    } else {
                        alert("Arquivo de backup inv√°lido!");
                    }
                } catch(erro) {
                    alert("Erro ao processar arquivo Excel: " + erro.message);
                }
            };
            reader.readAsArrayBuffer(file);
        } else {
            // Processa CSV
            const reader = new FileReader();
            reader.onload = (e) => {
                const linhas = e.target.result.split('\n').filter(l => l.trim());
                if(linhas.length > 0 && linhas[0].toUpperCase().includes('ETAPA')) {
                    dados = { educandos: [], turmas: [], avaliacoes: {} };
                    linhas.slice(1).forEach(l => {
                        const p = l.split(';');
                        if(p.length > 3 && !dados.avaliacoes[p[0]]) {
                            dados.educandos.push({id:p[0], nome:p[1], turma:p[2]});
                            if(!dados.turmas.includes(p[2])) dados.turmas.push(p[2]);
                            dados.avaliacoes[p[0]] = { 'Diagn√≥stica':{}, 'Processo':{}, 'Final':{} };
                        }
                        if(p.length > 3) {
                            INDICADORES.forEach((ind, i) => {
                                if(!dados.avaliacoes[p[0]][p[3]]) dados.avaliacoes[p[0]][p[3]] = {};
                                dados.avaliacoes[p[0]][p[3]][ind] = parseInt(p[i+4]) || 0;
                            });
                        }
                    });
                    salvar(); 
                    atualizarFiltrosTurma();
                    atualizarAbaAtiva();
                    alert("‚úì Backup importado com sucesso!");
                } else {
                    alert("Arquivo de backup inv√°lido!");
                }
            };
            reader.readAsText(file);
        }
        input.value = '';
    }

    function adicionarEducando() {
        const nome = prompt("Nome do Aluno:");
        if(!nome) return;
        
        let turma = '';
        
        if(dados.turmas.length > 0) {
            const opcao = confirm(`Deseja adicionar "${nome}" em uma turma existente?\n\nClique OK para escolher uma turma existente\nClique CANCELAR para criar uma nova turma`);
            
            if(opcao) {
                // Escolher turma existente
                const listaTurmas = dados.turmas.sort().map((t, i) => `${i+1}. ${t}`).join('\n');
                const escolha = prompt(`Selecione o n√∫mero da turma:\n\n${listaTurmas}`);
                
                if(escolha && !isNaN(escolha)) {
                    const index = parseInt(escolha) - 1;
                    if(index >= 0 && index < dados.turmas.length) {
                        turma = dados.turmas[index];
                    }
                }
            } else {
                // Criar nova turma
                turma = prompt("Nome da nova turma:");
            }
        } else {
            // N√£o h√° turmas, criar a primeira
            turma = prompt("Nome da turma:");
        }
        
        if(turma) {
            const id = "ID" + Date.now();
            dados.educandos.push({id, nome, turma});
            if(!dados.turmas.includes(turma)) dados.turmas.push(turma);
            dados.avaliacoes[id] = { 'Diagn√≥stica':{}, 'Processo':{}, 'Final':{} };
            salvar(); 
            atualizarFiltrosTurma(); 
            atualizarListaEducandos();
            atualizarVisaoGeral();
            atualizarCheckboxesTurmas();
        }
    }

    function mudarTurmaEducando(id, novaTurma) {
        if(!novaTurma) return;
        
        const educando = dados.educandos.find(e => e.id === id);
        if(!educando) return;
        
        const turmaAntiga = educando.turma;
        
        if(confirm(`Mover "${educando.nome}" de "${turmaAntiga}" para "${novaTurma}"?`)) {
            educando.turma = novaTurma;
            salvar();
            atualizarListaEducandos();
            atualizarVisaoGeral();
            alert(`‚úì Aluno movido com sucesso para ${novaTurma}!`);
        } else {
            // Reseta o select se cancelar
            atualizarListaEducandos();
        }
    }

    function remover(id) { 
        if(confirm("Remover aluno?")) { 
            dados.educandos = dados.educandos.filter(e => e.id !== id); 
            delete dados.avaliacoes[id]; 
            salvar(); 
            atualizarListaEducandos();
            atualizarVisaoGeral();
        } 
    }

    function gerenciarTurmas() {
        document.getElementById('modalTurmas').classList.add('active');
        atualizarListaTurmasModal();
    }

    function fecharModalTurmas() {
        document.getElementById('modalTurmas').classList.remove('active');
        document.getElementById('inputNovaTurma').value = '';
    }

    function atualizarListaTurmasModal() {
        const container = document.getElementById('listaTurmasModal');
        if(dados.turmas.length === 0) {
            container.innerHTML = '<p class="empty-state">Nenhuma turma cadastrada</p>';
            return;
        }
        
        container.innerHTML = dados.turmas.sort().map(turma => {
            const qtdAlunos = dados.educandos.filter(e => e.turma === turma).length;
            const temAlunos = qtdAlunos > 0;
            
            return `
                <div class="turma-item">
                    <div>
                        <strong>${turma}</strong>
                        <span style="color: #6b7280; font-size: 0.9em; margin-left: 10px;">(${qtdAlunos} aluno${qtdAlunos !== 1 ? 's' : ''})</span>
                    </div>
                    ${!temAlunos ? `<button class="btn btn-danger btn-small" onclick="excluirTurma('${turma}')">Excluir</button>` : '<span style="color: #9ca3af; font-size: 0.85em;">Tem alunos</span>'}
                </div>
            `;
        }).join('');
    }

    function adicionarNovaTurma() {
        const input = document.getElementById('inputNovaTurma');
        const nomeTurma = input.value.trim();
        
        if(!nomeTurma) {
            alert("Digite o nome da turma!");
            return;
        }
        
        if(dados.turmas.includes(nomeTurma)) {
            alert("Esta turma j√° existe!");
            return;
        }
        
        dados.turmas.push(nomeTurma);
        salvar();
        input.value = '';
        atualizarListaTurmasModal();
        atualizarFiltrosTurma();
        atualizarCheckboxesTurmas();
        alert(`‚úì Turma "${nomeTurma}" criada com sucesso!`);
    }

    function excluirTurma(turma) {
        const qtdAlunos = dados.educandos.filter(e => e.turma === turma).length;
        
        if(qtdAlunos > 0) {
            alert(`N√£o √© poss√≠vel excluir a turma "${turma}" pois ela possui ${qtdAlunos} aluno${qtdAlunos !== 1 ? 's' : ''} cadastrado${qtdAlunos !== 1 ? 's' : ''}!`);
            return;
        }
        
        if(confirm(`Excluir a turma "${turma}"?`)) {
            dados.turmas = dados.turmas.filter(t => t !== turma);
            salvar();
            atualizarListaTurmasModal();
            atualizarFiltrosTurma();
            atualizarCheckboxesTurmas();
            atualizarVisaoGeral();
            alert(`‚úì Turma "${turma}" exclu√≠da com sucesso!`);
        }
    }

    // Fecha modal ao clicar fora
    document.addEventListener('click', function(e) {
        const modal = document.getElementById('modalTurmas');
        if(e.target === modal) {
            fecharModalTurmas();
        }
    });

    function limparTudo() { 
        if(confirm("‚ö†Ô∏è ATEN√á√ÉO: Isso vai apagar TODOS os dados do sistema!\n\nDeseja continuar?")) { 
            // Limpa localStorage
            localStorage.removeItem('crescendo_dados_v1');
            // Limpa sessionStorage
            sessionStorage.removeItem('projeto_auth');
            // Recarrega a p√°gina
            location.reload(); 
        } 
    }
    
    function hexToRgba(hex, a) { 
        const r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16); 
        return `rgba(${r},${g},${b},${a})`; 
    }

    function atualizarFiltrosTurma() {
        document.querySelectorAll('.filtro-turma').forEach(sel => {
            const v = sel.value;
            sel.innerHTML = '<option value="">Turma...</option>' + (sel.id !== 'turmaAtivaAvaliacao' ? '<option value="todas">Todas</option>' : '');
            dados.turmas.sort().forEach(t => sel.innerHTML += `<option value="${t}">${t}</option>`);
            sel.value = v;
        });
    }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Projeto Crescendo Juntos - Sistema Estabilizado</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <style>
        :root {
            --primary: #f97316;
            --primary-dark: #ea580c;
            --bg-gradient: linear-gradient(135deg, #fbbf24 0%, #f97316 100%);
            --card-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg-gradient); min-height: 100vh; color: #1f2937; }

        /* TELA DE LOGIN */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-gradient); display: flex; justify-content: center; align-items: center; z-index: 9999;
        }
        .login-card {
            background: white; padding: 40px; border-radius: 20px; box-shadow: var(--card-shadow);
            text-align: center; max-width: 400px; width: 90%;
        }
        .login-card h2 { color: var(--primary-dark); margin-bottom: 10px; }
        .login-card input {
            width: 100%; padding: 12px; margin: 15px 0; border: 2px solid #e5e7eb; border-radius: 10px; text-align: center; font-size: 1.1em;
        }

        /* CONTE칔DO PRINCIPAL */
        #main-content { display: none; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header, .tabs, .card { background: white; border-radius: 15px; box-shadow: var(--card-shadow); margin-bottom: 20px; padding: 25px; }
        .header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px; }
        .header h1 { color: #92400e; }
        
        .tabs { display: flex; gap: 10px; padding: 10px 20px; }
        .tab-btn { padding: 12px 25px; border: none; background: transparent; cursor: pointer; font-weight: 600; color: #6b7280; border-bottom: 3px solid transparent; transition: 0.3s; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: #10b981; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-small { padding: 5px 10px; font-size: 0.8em; }

        .control-panel { background: #fff7ed; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap; border: 1px solid #ffedd5; }
        
        .educando-row { background: #fafafa; padding: 20px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #e5e7eb; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
        th { background: #f3f4f6; padding: 10px; text-align: left; font-size: 0.85em; color: #4b5563; }
        td { padding: 10px; border-bottom: 1px solid #f3f4f6; }
        
        select { padding: 8px; border-radius: 8px; border: 2px solid #e5e7eb; outline-color: var(--primary); background: white; }
        .chart-container { position: relative; height: 450px; width: 100%; }
        .empty-state { text-align: center; padding: 40px; color: #9ca3af; font-style: italic; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-card">
        <h2>游 Acesso Restrito</h2>
        <p>Senha: girassol_123</p>
        <input type="password" id="access-key" placeholder="Digite a senha" onkeypress="if(event.key==='Enter') handleLogin()">
        <button class="btn btn-primary" style="width: 100%; justify-content: center;" onclick="handleLogin()">Entrar</button>
        <p id="login-error" style="color: #ef4444; margin-top: 10px; display: none;">Senha incorreta. Tente novamente.</p>
    </div>
</div>

<div id="main-content">
    <div class="container">
        <header class="header">
            <div><h1>Crescendo Juntos</h1><p>An치lise de Evolu칞칚o Pedag칩gica</p></div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">Importar Backup</button>
                <button class="btn btn-success" onclick="exportarBackup()">Exportar Backup</button>
                <button class="btn btn-danger btn-small" onclick="logout()">Sair</button>
                <input type="file" id="fileInput" style="display:none" onchange="processarArquivo(this)">
            </div>
        </header>

        <nav class="tabs">
            <button class="tab-btn active" onclick="mudarAba('visao-geral', this)">Painel de Gr치ficos</button>
            <button class="tab-btn" onclick="mudarAba('avaliacoes', this)">Lan칞ar Notas (1-4)</button>
        </nav>

        <div id="visao-geral" class="tab-content active">
            <div class="card">
                <div style="display:flex; justify-content:space-between; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
                    <select class="filtro-turma" onchange="atualizarGrafico()"></select>
                    <select id="modoAnalise" onchange="atualizarGrafico()">
                        <option value="individual">Etapa 칰nica</option>
                        <option value="diag_proc">Diagn칩stica x Processo</option>
                        <option value="proc_final">Processo x Final</option>
                        <option value="diag_final">Diagn칩stica x Final</option>
                    </select>
                    <select id="tipoGrafico" onchange="atualizarGrafico()">
                        <option value="bar">Gr치fico de Barras</option>
                        <option value="radar">Gr치fico Radar</option>
                    </select>
                </div>
                <div class="chart-container"><canvas id="graficoIndicadores"></canvas></div>
            </div>
            <div class="card">
                <h3>Vis칚o geral das turmas</h3>
                <div id="visaoTurmasContainer" class="empty-state">Nenhuma turma cadastrada.</div>
            </div>
        </div>

        <div id="avaliacoes" class="tab-content">
            <div class="card">
                <div class="control-panel">
                    <div style="flex-grow: 1;">
                        <label><strong>Filtrar Turma:</strong></label>
                        <select class="filtro-turma" id="turmaAtivaAvaliacao" onchange="atualizarListaEducandos()"></select>
                    </div>
                    <button class="btn btn-primary" onclick="adicionarEducando()">+ Novo Aluno</button>
                    <button class="btn btn-danger btn-small" onclick="limparTudo()">Resetar Sistema</button>
                </div>
                <div id="educandosContainer"></div>
            </div>
        </div>
    </div>
</div>

<script>
    const CHAVE_MESTRA = "Z2lyYXNzb2xfMTIz"; 

    function handleLogin() {
        const campo = document.getElementById('access-key');
        const senhaDigitada = campo.value.trim();
        if (btoa(senhaDigitada) === CHAVE_MESTRA) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            sessionStorage.setItem('projeto_auth', 'true');
            atualizarFiltrosTurma();
            atualizarAbaAtiva();
        } else {
            document.getElementById('login-error').style.display = 'block';
            campo.value = '';
        }
    }

    if(sessionStorage.getItem('projeto_auth') === 'true') {
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            atualizarFiltrosTurma();
            atualizarAbaAtiva();
        });
    }

    const INDICADORES = ['Leitura', 'Escrita', 'Socializa칞칚o', 'Participa칞칚o', 'Autonomia', 'Racioc칤nio L칩gico'];
    const ETAPAS = ['Diagn칩stica', 'Processo', 'Final'];
    const CORES = { 'Diagn칩stica': '#f59e0b', 'Processo': '#3b82f6', 'Final': '#10b981' };
    let dados = { educandos: [], turmas: [], avaliacoes: {} };
    let graficoInstance = null;

    window.onload = () => {
        const salvos = localStorage.getItem('crescendo_dados_v1');
        if (salvos) dados = JSON.parse(salvos);
        if(sessionStorage.getItem('projeto_auth') === 'true') {
            atualizarFiltrosTurma();
            atualizarAbaAtiva();
        }
    };

    function logout() { sessionStorage.removeItem('projeto_auth'); location.reload(); }
    function salvar() { localStorage.setItem('crescendo_dados_v1', JSON.stringify(dados)); }

    function mudarAba(aba, btn) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(aba).classList.add('active');
        btn.classList.add('active');
        atualizarAbaAtiva();
    }

    function atualizarAbaAtiva() {
        const abaVisaoGeral = document.getElementById('visao-geral');
        const abaAvaliacoes = document.getElementById('avaliacoes');

        if (abaVisaoGeral.classList.contains('active')) {
            atualizarGrafico();
            atualizarVisaoGeral();
        }

        if (abaAvaliacoes.classList.contains('active')) {
            atualizarListaEducandos();
        }
    }

    function atualizarListaEducandos() {
        const turma = document.getElementById('turmaAtivaAvaliacao').value;
        const container = document.getElementById('educandosContainer');
        if (!turma) { container.innerHTML = '<div class="empty-state">Selecione uma turma acima.</div>'; return; }
        const lista = dados.educandos.filter(e => e.turma === turma);
        container.innerHTML = lista.map(edu => `
            <div class="educando-row">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px"><strong>${edu.nome}</strong><button class="btn btn-danger btn-small" onclick="remover('${edu.id}')">Excluir</button></div>
                <div style="overflow-x:auto">
                    <table>
                        <thead><tr><th>Crit칠rio</th>${ETAPAS.map(et => `<th>${et}</th>`).join('')}</tr></thead>
                        <tbody>
                            ${INDICADORES.map(ind => `
                                <tr><td>${ind}</td>${ETAPAS.map(et => `<td><select onchange="salvarNota('${edu.id}','${et}','${ind}',this.value)"><option value="0">-</option>${[1,2,3,4].map(n => `<option value="${n}" ${(dados.avaliacoes[edu.id] && dados.avaliacoes[edu.id][et] && dados.avaliacoes[edu.id][et][ind] == n) ? 'selected' : ''}>${n}</option>`).join('')}</select></td>`).join('')}</tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `).join('');
    }

    function salvarNota(id, et, ind, val) { 
        if(!dados.avaliacoes[id]) dados.avaliacoes[id] = { 'Diagn칩stica':{}, 'Processo':{}, 'Final':{} };
        if(!dados.avaliacoes[id][et]) dados.avaliacoes[id][et] = {};
        dados.avaliacoes[id][et][ind] = parseInt(val); 
        salvar(); 
    }

    function atualizarGrafico() {
        const canvas = document.getElementById('graficoIndicadores');
        if (!canvas || !window.Chart) return;
        const ctx = canvas.getContext('2d');
        const turma = document.querySelector('.filtro-turma').value;
        const modo = document.getElementById('modoAnalise').value;
        const etapas = (modo === 'individual' ? ['Diagn칩stica'] : modo === 'diag_proc' ? ['Diagn칩stica', 'Processo'] : modo === 'proc_final' ? ['Processo', 'Final'] : ['Diagn칩stica', 'Final']);
        const datasets = etapas.map(et => {
            const medias = INDICADORES.map(ind => {
                const notas = dados.educandos.filter(e => turma === 'todas' || e.turma === turma).map(e => (dados.avaliacoes[e.id] && dados.avaliacoes[e.id][et]) ? dados.avaliacoes[e.id][et][ind] : 0).filter(n => n > 0);
                return notas.length ? (notas.reduce((a,b)=>a+b,0)/notas.length).toFixed(2) : 0;
            });
            return { label: et, data: medias, borderColor: CORES[et], backgroundColor: hexToRgba(CORES[et], 0.2), fill: true };
        });
        if(graficoInstance) graficoInstance.destroy();
        graficoInstance = new Chart(ctx, { type: document.getElementById('tipoGrafico').value, data: { labels: INDICADORES, datasets }, options: { scales: { y: { beginAtZero: true, max: 4 }, r: { beginAtZero: true, max: 4 } }, maintainAspectRatio: false } });
    }

    function atualizarVisaoGeral() {
        const container = document.getElementById('visaoTurmasContainer');
        if(!container) return;
        if(!dados.turmas || dados.turmas.length === 0) {
            container.innerHTML = '<div class="empty-state">Nenhuma turma cadastrada.</div>';
            return;
        }
        container.innerHTML = dados.turmas.sort().map(t => {
            const count = dados.educandos.filter(e => e.turma === t).length;
            return `<div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #f3f4f6;"><strong>${t}</strong><span>${count} aluno${count !== 1 ? 's' : ''}</span></div>`;
        }).join('');
    }

    function exportarBackup() {
        let csv = 'ID;NOME;TURMA;ETAPA;' + INDICADORES.join(';') + '\n';
        dados.educandos.forEach(e => ETAPAS.forEach(et => {
            const notas = INDICADORES.map(ind => (dados.avaliacoes[e.id] && dados.avaliacoes[e.id][et]) ? dados.avaliacoes[e.id][et][ind] : 0);
            csv += `${e.id};${e.nome};${e.turma};${et};${notas.join(';')}\n`;
        }));
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob(["\ufeff", csv], { type: 'text/csv' })); a.download = 'backup.csv'; a.click();
    }

    function processarArquivo(input) {
        const reader = new FileReader();
        reader.onload = (e) => {
            const linhas = e.target.result.split('\n').filter(l => l.trim());
            if(linhas[0].toUpperCase().includes('ETAPA')) {
                dados = { educandos: [], turmas: [], avaliacoes: {} };
                linhas.slice(1).forEach(l => {
                    const p = l.split(';');
                    if(!dados.avaliacoes[p[0]]) {
                        dados.educandos.push({id:p[0], nome:p[1], turma:p[2]});
                        if(!dados.turmas.includes(p[2])) dados.turmas.push(p[2]);
                        dados.avaliacoes[p[0]] = { 'Diagn칩stica':{}, 'Processo':{}, 'Final':{} };
                    }
                    INDICADORES.forEach((ind, i) => dados.avaliacoes[p[0]][p[3]][ind] = parseInt(p[i+4]) || 0);
                });
            }
            salvar(); 
            atualizarFiltrosTurma();
            atualizarAbaAtiva();
            alert("Dados importados!");
        };
        reader.readAsText(input.files[0]);
    }

    function adicionarEducando() {
        const n = prompt("Nome do Aluno:"), t = prompt("Turma:");
        if(n && t) {
            const id = "ID" + Date.now();
            dados.educandos.push({id, nome:n, turma:t});
            if(!dados.turmas.includes(t)) dados.turmas.push(t);
            dados.avaliacoes[id] = { 'Diagn칩stica':{}, 'Processo':{}, 'Final':{} };
            salvar(); 
            atualizarFiltrosTurma(); 
            atualizarListaEducandos();
            atualizarVisaoGeral();
        }
    }

    function remover(id) { 
        if(confirm("Remover aluno?")) { 
            dados.educandos = dados.educandos.filter(e => e.id !== id); 
            delete dados.avaliacoes[id]; 
            salvar(); 
            atualizarListaEducandos();
            atualizarVisaoGeral();
        } 
    }

    function limparTudo() { if(confirm("Apagar todos os dados?")) { localStorage.clear(); location.reload(); } }
    
    function hexToRgba(hex, a) { 
        const r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16); 
        return `rgba(${r},${g},${b},${a})`; 
    }

    function atualizarFiltrosTurma() {
        document.querySelectorAll('.filtro-turma').forEach(sel => {
            const v = sel.value;
            sel.innerHTML = '<option value="">Turma...</option>' + (sel.id !== 'turmaAtivaAvaliacao' ? '<option value="todas">Todas</option>' : '');
            dados.turmas.sort().forEach(t => sel.innerHTML += `<option value="${t}">${t}</option>`);
            sel.value = v;
        });
    }
</script>
</body>
</html>